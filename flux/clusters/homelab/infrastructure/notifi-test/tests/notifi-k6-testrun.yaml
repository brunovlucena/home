apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: notifi-infrastructure-test
  namespace: notifi-test
  labels:
    app: notifi-k6-test
    component: testing
    test-type: infrastructure
spec:
  parallelism: 4
  script:
    configMap:
      name: notifi-k6-test
      file: k6-tests.js
  runner:
    image: ghcr.io/szkiba/xk6-prometheus:latest
    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 200m
        memory: 256Mi
    env:
      - name: K6_LOG_LEVEL
        value: "info"
      - name: K6_OUT
        value: "json=test-results.json"
      - name: K6_PROMETHEUS_RW_SERVER_URL
        value: "http://prometheus-operator-kube-p-prometheus.prometheus.svc:9090/api/v1/write"
      - name: K6_PROMETHEUS_RW_PUSH_INTERVAL
        value: "5s"
      - name: K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM
        value: "true"
  starter:
    image: ghcr.io/szkiba/xk6-prometheus:latest
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
    env:
      - name: K6_LOG_LEVEL
        value: "info"
  # Test configuration - using the options from the script
  arguments: "--vus=20 --duration=3m"
  # Cleanup after test completion
  cleanup: "post"
