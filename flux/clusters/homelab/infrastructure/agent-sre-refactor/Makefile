# SRE Agent Refactored - Makefile
# Separate MCP Server and Agent deployments

.PHONY: help build-mcp build-agent build-all deploy-mcp deploy-agent deploy-all start stop clean test health logs

# Default target
help:
	@echo "ğŸš€ SRE Agent Refactored - Available Commands:"
	@echo ""
	@echo "  ğŸ“¦ Build Commands:"
	@echo "    make build-mcp          - Build MCP server Docker image"
	@echo "    make build-agent         - Build Agent Docker image"
	@echo "    make build-all           - Build both images"
	@echo ""
	@echo "  ğŸš€ Deploy Commands:"
	@echo "    make deploy-mcp          - Deploy MCP server to Kubernetes"
	@echo "    make deploy-agent        - Deploy Agent to Kubernetes"
	@echo "    make deploy-all          - Deploy both services"
	@echo ""
	@echo "  ğŸ³ Docker Commands:"
	@echo "    make start               - Start services with docker-compose"
	@echo "    make stop                - Stop services"
	@echo "    make logs                - Show logs"
	@echo ""
	@echo "  ğŸ§ª Test Commands:"
	@echo "    make test                - Run tests"
	@echo "    make health              - Check health of all services"
	@echo ""
	@echo "  ğŸ§¹ Cleanup Commands:"
	@echo "    make clean               - Clean up resources"
	@echo ""

# Build MCP Server
build-mcp:
	@echo "ğŸ”¨ Building MCP Server Docker image..."
	docker build -f deployments/mcp-server/Dockerfile -t ghcr.io/brunovlucena/agent-sre-mcp-server:latest .
	@echo "âœ… MCP Server image built successfully"

# Build Agent
build-agent:
	@echo "ğŸ”¨ Building Agent Docker image..."
	docker build -f deployments/agent/Dockerfile -t ghcr.io/brunovlucena/agent-sre-agent:latest .
	@echo "âœ… Agent image built successfully"

# Build all images
build-all: build-mcp build-agent
	@echo "âœ… All images built successfully"

# Deploy MCP Server to Kubernetes
deploy-mcp:
	@echo "ğŸš€ Deploying MCP Server to Kubernetes..."
	kubectl apply -f deployments/mcp-server/k8s-mcp-server.yaml
	@echo "âœ… MCP Server deployed successfully"

# Deploy Agent to Kubernetes
deploy-agent:
	@echo "ğŸš€ Deploying Agent to Kubernetes..."
	kubectl apply -f deployments/agent/k8s-agent.yaml
	@echo "âœ… Agent deployed successfully"

# Deploy all services
deploy-all: deploy-mcp deploy-agent
	@echo "âœ… All services deployed successfully"

# Start services with docker-compose
start:
	@echo "ğŸ³ Starting services with docker-compose..."
	docker-compose up -d
	@echo "âœ… Services started successfully"
	@echo "ğŸŒ MCP Server: http://localhost:30120"
	@echo "ğŸŒ Agent: http://localhost:8080"
	@echo "ğŸŒ Nginx: http://localhost:80"

# Stop services
stop:
	@echo "ğŸ›‘ Stopping services..."
	docker-compose down
	@echo "âœ… Services stopped successfully"

# Show logs
logs:
	@echo "ğŸ“‹ Showing logs..."
	docker-compose logs -f

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	@echo "Testing MCP Server health..."
	curl -f http://localhost:30120/health || echo "âŒ MCP Server health check failed"
	@echo "Testing Agent health..."
	curl -f http://localhost:8080/health || echo "âŒ Agent health check failed"
	@echo "Testing MCP Server readiness..."
	curl -f http://localhost:30120/ready || echo "âŒ MCP Server readiness check failed"
	@echo "Testing Agent readiness..."
	curl -f http://localhost:8080/ready || echo "âŒ Agent readiness check failed"

# Check health of all services
health:
	@echo "ğŸ¥ Checking health of all services..."
	@echo ""
	@echo "ğŸ“Š MCP Server Health:"
	curl -s http://localhost:30120/health | jq . || echo "âŒ MCP Server not responding"
	@echo ""
	@echo "ğŸ“Š Agent Health:"
	curl -s http://localhost:8080/health | jq . || echo "âŒ Agent not responding"
	@echo ""
	@echo "ğŸ“Š Agent Status:"
	curl -s http://localhost:8080/status | jq . || echo "âŒ Agent status not available"
	@echo ""
	@echo "ğŸ“Š MCP Server Status:"
	curl -s http://localhost:8080/mcp/status | jq . || echo "âŒ MCP Server status not available"

# Clean up resources
clean:
	@echo "ğŸ§¹ Cleaning up resources..."
	docker-compose down -v
	docker system prune -f
	@echo "âœ… Cleanup completed"

# Test MCP communication
test-mcp:
	@echo "ğŸ§ª Testing MCP communication..."
	@echo "Testing MCP chat..."
	curl -X POST http://localhost:8080/mcp/chat \
		-H "Content-Type: application/json" \
		-d '{"message": "How do I monitor Kubernetes pods?"}' | jq .
	@echo ""
	@echo "Testing MCP log analysis..."
	curl -X POST http://localhost:8080/mcp/analyze-logs \
		-H "Content-Type: application/json" \
		-d '{"logs": "ERROR: Database connection failed"}' | jq .

# Test direct agent communication
test-agent:
	@echo "ğŸ§ª Testing direct agent communication..."
	@echo "Testing direct chat..."
	curl -X POST http://localhost:8080/chat \
		-H "Content-Type: application/json" \
		-d '{"message": "How do I monitor Kubernetes pods?"}' | jq .
	@echo ""
	@echo "Testing direct log analysis..."
	curl -X POST http://localhost:8080/analyze-logs \
		-H "Content-Type: application/json" \
		-d '{"logs": "ERROR: Database connection failed"}' | jq .

# Push images to registry
push-mcp:
	@echo "ğŸ“¤ Pushing MCP Server image to registry..."
	docker push ghcr.io/brunovlucena/agent-sre-mcp-server:latest
	@echo "âœ… MCP Server image pushed successfully"

push-agent:
	@echo "ğŸ“¤ Pushing Agent image to registry..."
	docker push ghcr.io/brunovlucena/agent-sre-agent:latest
	@echo "âœ… Agent image pushed successfully"

push-all: push-mcp push-agent
	@echo "âœ… All images pushed successfully"

# Scale services
scale-mcp:
	@echo "ğŸ“ˆ Scaling MCP Server..."
	kubectl scale deployment sre-agent-mcp-server --replicas=3 -n agent-sre
	@echo "âœ… MCP Server scaled to 3 replicas"

scale-agent:
	@echo "ğŸ“ˆ Scaling Agent..."
	kubectl scale deployment sre-agent --replicas=3 -n agent-sre
	@echo "âœ… Agent scaled to 3 replicas"

# Get service URLs
urls:
	@echo "ğŸŒ Service URLs:"
	@echo "MCP Server: http://localhost:30120"
	@echo "Agent: http://localhost:8080"
	@echo "Nginx: http://localhost:80"
	@echo ""
	@echo "Kubernetes NodePort URLs:"
	@echo "MCP Server: http://localhost:31120"
	@echo "Agent: http://localhost:31080"

# Monitor services
monitor:
	@echo "ğŸ“Š Monitoring services..."
	watch -n 5 'curl -s http://localhost:30120/health | jq .status && curl -s http://localhost:8080/health | jq .status'
